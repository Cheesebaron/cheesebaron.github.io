---
layout: post
title: Firebase Cloud Messaging in Xamarin.Android
date: '2016-11-11T21:12:00.000+01:00'
author: Tomasz Cielecki
tags:
- Firebase
- Notifications
- GCM
- Xamarin.Android
- Xamarin
- FCM
modified_time: '2016-11-30T20:15:32.710+01:00'
thumbnail: https://4.bp.blogspot.com/-RmzZC7rmcok/WCXgXsih_DI/AAAAAAAADyQ/AJZMxYFJBugmXWPadGasoQI2i62777uzgCLcB/s72-c/1.PNG
blogger_id: tag:blogger.com,1999:blog-3433282516380174051.post-1559411483356934547
blogger_orig_url: http://blog.ostebaronen.dk/2016/11/firebase-cloud-messaging-in.html
---

I've seen people asking a lot about this lately on <a href="https://xamarinchat.herokuapp.com/">XamarinChat Slack</a>. Looking around there does not seem to be much good information on how to get Firebase Cloud Messaging (FCM) to work in a Xamarin.Android project. I made the switch in one of my apps a month or so ago, from Google Cloud Messaging to FCM and I too was lacking the information about how to get this to work. I did get it to work by piecing together information from the Java world. Surprisingly enough it is not that much different in Xamarin.Android.<br /><h3>1. Creating a Firebase Project</h3>If you have not already created a <a href="https://firebase.google.com/">Firebase project</a> you need to do so now. You can either opt to import an existing Google project or Creating a new. Either way the instructions are pretty much the same.<br /><br />1. Go to the <a href="https://console.firebase.google.com/">Firebase Console</a><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-RmzZC7rmcok/WCXgXsih_DI/AAAAAAAADyQ/AJZMxYFJBugmXWPadGasoQI2i62777uzgCLcB/s1600/1.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="220" src="https://4.bp.blogspot.com/-RmzZC7rmcok/WCXgXsih_DI/AAAAAAAADyQ/AJZMxYFJBugmXWPadGasoQI2i62777uzgCLcB/s320/1.PNG" width="320" /></a></div><br />2. Create a new project or import Google Project<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-BnGI4xlfaQw/WCXgaKSV8cI/AAAAAAAADyU/zULoRQ80o30JozQDEFINYDVWRi8NMEsOQCLcB/s1600/2.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="297" src="https://1.bp.blogspot.com/-BnGI4xlfaQw/WCXgaKSV8cI/AAAAAAAADyU/zULoRQ80o30JozQDEFINYDVWRi8NMEsOQCLcB/s320/2.PNG" width="320" /></a></div><br /><br />I don't think it is super important what region you choose your project to be in. I just chose the region where I expect the most users to use my App.<br /><br /><h3>2. Registering Application</h3>When you have created your project or imported an existing one you can now add your application. This can be done several places in the console. I just went to Notifications and it prompted me to add an application. <br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-aetQpqXoFDI/WCXg961BqyI/AAAAAAAADyc/dkoV3ID0Jz8ajAJI7Ij7DZgG5iJW8WNmwCLcB/s1600/3.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="245" src="https://4.bp.blogspot.com/-aetQpqXoFDI/WCXg961BqyI/AAAAAAAADyc/dkoV3ID0Jz8ajAJI7Ij7DZgG5iJW8WNmwCLcB/s400/3.PNG" width="400" /></a></div>Pressing the Android icon will show you the following dialog<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-b0lq15yhvfo/WCXhLr3VWwI/AAAAAAAADyg/krkqdstHfloj1cdTEwwkbQcZFd_sUtNCACLcB/s1600/4.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://4.bp.blogspot.com/-b0lq15yhvfo/WCXhLr3VWwI/AAAAAAAADyg/krkqdstHfloj1cdTEwwkbQcZFd_sUtNCACLcB/s320/4.PNG" width="300" /></a></div>Here you need to enter the details of your Application. Package name is the package name you have set in your AndroidManifest.xml file. You might want to change that to something resembling your namespace in your app. Make sure that it is all lowercase too. Nickname is optional and is just an easy way to identify your app in the Console. Press <i>Add App</i> or optionally do step 2.1 first to add a SHA-1, then press <i>Add App</i>. The browser will now download a google-services.json file, which we will use later, in step 4.<br /><h4>2.1 Creating a keystore (optional)</h4>If you haven't already created a keystore file for your App, you can do so now. For more information <a href="https://developer.xamarin.com/guides/android/deployment,_testing,_and_metrics/MD5_SHA1/">refer to the Xamarin Documentation</a>.<br />You will need it for deploying to Google Play Store anyways. You will need it for Google Play Services, such as Google Maps. Easiest way to do so is through the Archive tool in Visual Studio or Xamrin Studio, which you can trigger by right clicking your Android Application project. Make sure to have selected Release Configuration and your App can build.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-l1xxU-5nCbg/WCXiYO4UphI/AAAAAAAADys/lJ_BEDJLI8QVqlMkwx_tslF3wV8x1zpQACLcB/s1600/5.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="188" src="https://4.bp.blogspot.com/-l1xxU-5nCbg/WCXiYO4UphI/AAAAAAAADys/lJ_BEDJLI8QVqlMkwx_tslF3wV8x1zpQACLcB/s320/5.PNG" width="320" /></a></div>At the bottom of the Archive screen, when an Archive is ready, click <b>Distribute... &gt; Ad Hoc &gt; <complete id="goog_3973191"></complete></b><complete id="goog_3973191">+</complete><br /><complete id="goog_3973191">A dialog for creating a new keystore will appear, which you will need to fill out with relevant details. Create your keystore and now we need to find it on the computer.</complete><br /><blockquote class="tr_bq"><complete id="goog_3973191">Note: A keystore is used to sign the application, for deployment on the Google Play Store. Many Google Play Services require a SHA-1 entered into the Google Console for your App package</complete></blockquote>On Windows, Xamarin Archives put the keystore in <b>C:\Users\&lt;username&gt;\AppData\Local\Xamarin\Mono for Android\Keystore</b> you can find the one you just created in a subfolder maching the name of the keystore you just created. To get the SHA-1 from a keystore you run the keytool command line tool. If it isn't in your environment PATH, it is located in the Java SDK folder. In my case <b>C:\Program Files\Java\jdk1.8.0_102\bin</b> lets just assume you don't have it in your environment PATH the command to get the SHA-1 would look something like<br /><br /><b>"C:\Program Files\Java\jdk1.8.0_102\bin\keytool.exe" -exportcert -list -v -alias </b><i>yourkeystorealias</i> <b>-keystore </b><b><b>C:\Users\&lt;username&gt;\AppData\Local\Xamarin\Mono for Android\Keystore\fcmtest\fcmtest.keystore</b></b><br /><br /><i>yourkeystorealias</i> being the name of your keystore in this case. Although a keystore can contain multiple aliases, which the Xamarin Archive tool does not seem to care about.<b><b> </b></b>The output will look like follows<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-k6Wa7MJVYko/WCX6XamX12I/AAAAAAAADy8/9B4AyAgP0kolVzejW5ZSG-WIW90BR2HOwCLcB/s1600/7.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="183" src="https://4.bp.blogspot.com/-k6Wa7MJVYko/WCX6XamX12I/AAAAAAAADy8/9B4AyAgP0kolVzejW5ZSG-WIW90BR2HOwCLcB/s400/7.PNG" width="400" /></a></div>We need the SHA-1, you can enter that in the certificate SHA-1 for your Firebase Project.<br />You can also grab the one from the debug.keystore in the <b>C:\Users\&lt;username&gt;\AppData\Local\Xamarin\Mono for Android</b> folder and enter that later as an additional fingerprint in the Firebase console.<br /><br /><h3>3. Adding FCM NuGet to your project&nbsp;</h3>Before we proceed and before we can do 4. where we add the google-services.json to our project. We need to add some NuGet for the FCM stuff, but also for the Build Action needed in 4., which comes with the Google Play Services Nuget.<br /><br />Add the <b>Xamarin.Firebase.Messaging</b> NuGet to your project. Currently there is only a pre-release version of it. Hence you need to tick the Include Prerelease box in your NuGet package manager.<br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-1_br1ktZuhw/WCYMXWuK_uI/AAAAAAAADzM/pFDiKrYzdmcdYH85CGgxBd7eSrxSMePlQCLcB/s1600/9.PNG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="92" src="https://2.bp.blogspot.com/-1_br1ktZuhw/WCYMXWuK_uI/AAAAAAAADzM/pFDiKrYzdmcdYH85CGgxBd7eSrxSMePlQCLcB/s400/9.PNG" width="400" /></a></div><h3>&nbsp;</h3><h3>4. Adding google-services.json to the application</h3>We will now add the google-services.json file from 2. to the Android project.<br /><br />Right click your project, select <b>Add &gt; Exisiting Item</b> find the google-services.json in the folder your browser downloaded it to, then press <b>Add.</b><br /><br />Now we need to set the build action of that file to <i>GoogleServicesJson.</i><br /><blockquote class="tr_bq">Note: If the GoogleServicesJson Build Action is not present, follow the instructions in <a href="https://github.com/xamarin/GooglePlayServicesComponents/issues/25">this GitHub issue</a><i> </i>which tells you to: 1. clean/rebuild your project. 2. restart Visual Studio/Xamarin Studio. 3. make sure that the csproj file includes <i>Xamarin.GooglePlayServices.Basement.targets</i></blockquote>Add the Build Action by right clicking the google-servies.json file you added to your project. Click Properties. In there set the Build Action.<br /><br /><h3>5. Adding FCM receivers to the AndroidManifest</h3>Inside the AndroidManifest.xml we need to add a couple of entries for the FCM BroadcastReceivers, which are not added by the NuGet package.<br /><br />Locate the <i>&lt;application&gt;</i> tag in your manifest. Inside of that node add the following code<br /><br /><script src="https://gist.github.com/Cheesebaron/09d377335b22d8f3d77bc8462ac325ce.js?file=AndroidManifest.xml"></script>${applicationId} will get replaced at build time, with your App's package name. Make sure your package name conforms to Android's guidelines.<br /><br /><h3>6. Implementing FirebaseInstanceIdService and FirebaseMessagingService</h3>Now we need to add two services in our App. FirebaseInstanceIdService, which gives us the token used to identify the FCM registration of this particular device. This is normally used with a backend to tell it how to send notifications to the device.<br />FirebaseMessagingService is the service, which will be invoked when we receive a notification in the application. Here you prepare the notification to be displayed with data coming from the FCM.<br /><br /><h4>6.1 FirebaseInstanceIdService</h4>In order to receive the token from the App's registration with FCM, we need to implement FirebaseInstanceIdService. In here you would save the token and communicate it to the backend, which sends the notifications to the App.<br /><br /><script src="https://gist.github.com/Cheesebaron/09d377335b22d8f3d77bc8462ac325ce.js?file=FirebaseInstanceIdService.cs"></script><br />What I usually do in step 1. and 2. in the todo comment is to check with the token I saved in SharedPreferences whether it has changed and override it if it has. Then I send a request to my backend with the new token.<br /><h4><br />6.2 FirebaseMessagingService</h4>The FirebaseMessagingService is where we receive our notifications. Here you will get the data out of the notification sent to you. If you have sent extra stuff with your notification, take a look at the <i>Data</i> property on the <i>RemoteMessage</i> argument we get in <i>OnMessageReceived</i>. This will probably also apply to raw notifications that do not trigger any visual feedback.<br /><br />In either case here is some sample code to get you started. Here I simply grab the Title and Body sent with the notification and present it with an Intent to start my <i>MainActivity.</i> The <i>Intent</i> accepts extras which you can add to it and when the notification triggers your Activity you can pull that data out and act accordingly.<br /><br /><script src="https://gist.github.com/Cheesebaron/09d377335b22d8f3d77bc8462ac325ce.js?file=FirebaseListenerService.cs"></script> That should be it! Build and fire up your Application and use the Firebase Console to send some test notifications.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-j0mcCRZA6FU/WCYkdRdnY5I/AAAAAAAADzc/RGe013QqPjoDXv6VZiEtF8HkBKja56OSgCLcB/s1600/device-2016-11-11-210429.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="https://1.bp.blogspot.com/-j0mcCRZA6FU/WCYkdRdnY5I/AAAAAAAADzc/RGe013QqPjoDXv6VZiEtF8HkBKja56OSgCLcB/s320/device-2016-11-11-210429.png" width="180" /></a></div><br /><br /><br /><br />The <a href="https://github.com/xamarin/GooglePlayServicesComponents/tree/v9.4.0/firebase-messaging/samples/FirebaseMessagingQuickstart">GooglePlayServicesComponents repository that Xamarin has on GitHub</a>, contains a sample application that you can take a look at if you need a starting point. You can also take a look at the documentation from the <a href="https://github.com/xamarin/GooglePlayServicesComponents/blob/v9.4.0/firebase-messaging/component/GettingStarted.template.md">Firebase Component not yet in the Xamarin Component store</a>.