---
layout: post
title: Adding images to TextView and EditText using Spannables in Mono for Android
date: '2013-02-26T01:55:00.002+01:00'
author: Tomasz Cielecki
tags:
- Mono for Android
- EditText
- TextView
- Formatting
- Spannables
modified_time: '2013-02-26T09:48:31.498+01:00'
thumbnail: http://4.bp.blogspot.com/-ZfQWQ_qtKIw/USx1cvwVn9I/AAAAAAAAB-8/eXduCvji66Q/s72-c/EditText+with+smileys.png
blogger_id: tag:blogger.com,1999:blog-3433282516380174051.post-9175066612699398299
blogger_orig_url: http://blog.ostebaronen.dk/2013/02/adding-images-to-textview-and-edittext.html
---

I've just been playing around with Spannables in an attempt to help out a user on the <a href="http://forums.xamarin.com/categories/android">Xamarin Forums</a>, his topic is <a href="http://forums.xamarin.com/discussion/1649/text-with-image#latest">"Text With Image"</a>. Just from looking at that topic name, I thought: "Hey, he probably just want to show an image next to some text or something, this should be easy enough". Then I looked inside, and they guy actually wanted text inline with text when actually editing it. Now I thought: "How do I do that?!"<br /><div>I think I have touched the concept of Spannables briefly before, when I helped a guy making a sub-part of a text bold or something, but I never thought they could be used for displaying images inline with text. I guess this is how it is done in all those messaging apps, which show emoticons. I decided to use that as a sample.</div><div><br /></div><div>I started out with a super simple sample trying to get an Image shown in a TextView. I googled up some solutions and sure, Spannables allow using ImageSpan inside of them! There were nice samples and such, and I came up with this.</div><div><script class="brush: csharp;" title="ImageSpan in TextView" type="syntaxhighlighter"><![CDATA[ //Load up your drawable. var imageSpan = new ImageSpan(this, Resource.Drawable.Icon); //Set the text of SpannableString from TextView var spannableString = new SpannableString(textView.Text); //Add image at end of string spannableString.SetSpan(imageSpan, textView.Text.Length-1, textView.Text.Length, 0); ]]></script> Easy, huh? And you can add loads of other Spans to the Spannable, such as StyleSpan, which you can style your fonts with bold, italic and other styles.</div><div><br />Since that was so easy, I quickly tried to do that with an EditText. It also works just fine, so moving on. How do I imitate those messaging apps, which replace ":-)" with an actual smiley. Now EditText has some nice events which you can listen to for changes. I listen for AfterTextChanged, from here I can get the Editable Property from the argument, which is essentially a Spannable you can edit and the changes will be reflected in the EditText. This is probably a good place to replace text with images. <br />Next I cooked up a class which holds a Dictionary of strings and ints. The string keys are the text representation of the smileys, i.e. :), :-), :D, :P and so on. The ints are the Android Resource ids for the Drawables representing the smileys. Then I have a method for replacing all the matches in the string with their respective Drawables. It looks like this. <script class="brush: csharp;" title="AddSmiles()" type="syntaxhighlighter"><![CDATA[ public static bool AddSmiles(Context context, ISpannable spannable) {  var hasChanges = false;  foreach (var entry in Emoticons)  {   var smiley = entry.Key;   foreach (var index in spannable.ToString().IndexesOf(smiley))   {    var set = true;    foreach (ImageSpan span in spannable.GetSpans(index, index + smiley.Length, Java.Lang.Class.FromType(typeof(ImageSpan))))    {     if (spannable.GetSpanStart(span) >= index       && spannable.GetSpanEnd(span) <= index + smiley.Length)      spannable.RemoveSpan(span);     else     {      set = false;      break;     }    }    if (set)    {     hasChanges = true;     spannable.SetSpan(new ImageSpan(context, entry.Value),       index, index + smiley.Length, SpanTypes.ExclusiveExclusive);    }   }  }  return hasChanges; } ]]></script><br />Now you might notice I am removing all the images if they are present. This is because it is not possible to have two Spans at the same index in a Spannable, hence they need to be removed. Don't worry all the images are added at the end. This simply loops all the string matches in the Spannable and adds ImageSpans for the matches. Very simple. To get all the indices in a string which match I use a simple extension I found on StackOverflow. <br /><script class="brush: csharp;" title="IndexesOf()" type="syntaxhighlighter"><![CDATA[ //Taken from http://stackoverflow.com/a/767788/368379 public static class StringExtensions {  public static IEnumerable<int> IndexesOf(this string haystack, string needle)  {   var lastIndex = 0;   while (true)   {    var index = haystack.IndexOf(needle, lastIndex);    if (index == -1)    {     yield break;    }    yield return index;    lastIndex = index + needle.Length;   }  } } ]]></script> Now the AddSmiles() method is hooked up to the AfterTextChanged event for the EditText, and voila. Text is replaced with images! <script class="brush: csharp;" title="ImageSpans in EditText" type="syntaxhighlighter"><![CDATA[ _editText = FindViewById<edittext>(Resource.Id.editText1); _editText.AfterTextChanged += (sender, args) => SpannableTools.AddSmiles(this, args.Editable); ]]></script><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-ZfQWQ_qtKIw/USx1cvwVn9I/AAAAAAAAB-8/eXduCvji66Q/s1600/EditText+with+smileys.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="640" src="http://4.bp.blogspot.com/-ZfQWQ_qtKIw/USx1cvwVn9I/AAAAAAAAB-8/eXduCvji66Q/s640/EditText+with+smileys.png" width="384" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Pretty awesome smileys :-D&nbsp;</td></tr></tbody></table>The complete sample code can be found in this <b>Gist: <a href="https://gist.github.com/Cheesebaron/5034440">https://gist.github.com/Cheesebaron/5034440</a></b><br /><br />You can also watch this video for a demonstration <iframe allowfullscreen="" frameborder="0" height="315" src="http://www.youtube.com/embed/pc3RuXvSeC4" width="420"></iframe><br /><br /></div><div><br />For references on how to do this in Java I used:<br /><br /><ul><li><a href="http://stackoverflow.com/questions/3341702/displaying-emoticons-in-android/4302199#4302199">http://stackoverflow.com/questions/3341702/displaying-emoticons-in-android/4302199#4302199</a></li><li><a href="http://stackoverflow.com/questions/13867815/text-is-messed-up-with-imagespan-in-edittext">http://stackoverflow.com/questions/13867815/text-is-messed-up-with-imagespan-in-edittext</a></li></ul></div>