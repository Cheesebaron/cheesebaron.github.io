---
layout: post
title: Fragments and ViewPager with Mvx
date: '2013-07-15T15:32:00.000+02:00'
author: Tomasz Cielecki
tags:
- MvvmCross
- Xamarin.Android
modified_time: '2013-07-16T00:46:12.806+02:00'
thumbnail: http://i1.ytimg.com/vi/fGsEHVOy8Q0/0.jpg
blogger_id: tag:blogger.com,1999:blog-3433282516380174051.post-7086467078492664069
blogger_orig_url: http://blog.ostebaronen.dk/2013/07/fragments-and-viewpager-with-mvx.html
---

I've been toying around with MvvmCross (Mvx) and Fragments lately and found out that my binding for the ViewPager is only working if you are using old type of Activities and Views. So in this blog post I will describe what I did to get the ViewPager to work nicely with Fragments and Mvx.<br /><br />I have made some code samples which are shown in the bottom of this blog post and which I will refer to. So to start with, let me explain why this approach is necessary. There are currently no official bindings for the <i>ViewPager</i> for Mvx for Xamarin.Android. However,<a href="https://github.com/Cheesebaron/Cheesebaron.MvvmCross.Bindings" target="_blank"> I did make one</a>, and it works pretty well and binds to the <i>ViewPager</i> like you would with a <i>ListView</i>. In fact you can use different <i>ItemTemplates</i> such that you can display different kinds of <i>Views</i> inside the <i>ViewPager</i>. How to do that is decribed in the <a href="https://github.com/slodge/MvvmCross-Tutorials/blob/master/Working%20With%20Collections/Collections.Droid/Views/PolymorphicListItemTypesView.cs" target="_blank">Working with Collections Tutorial in the MvvmCross Tutorials repository</a>.<br />With <i>Fragments</i> that approach changes. Now a <i>FragmentPagerAdapter</i> is required, which creates instances of <i>Fragments</i> and keeps track of which are shown on the screen and which to cache, much in the same fashion as a normal <i>Adapter</i> for <i>ListView</i>s. However <i>Fragments</i> are a lot different as they have their own life-cycle and with Mvx each of them have their own <i>ViewModel</i> as well, just like you previously would have a <i>ViewModel</i> for<i> </i>an <i>Activity. </i>The binding of the <i>View</i> associated to a <i>Fragment</i> also happens inside that <i>Fragment</i>. So the binding action which previously was inside the <i>Adapter</i>, now is handled in the <i>Fragment.</i> This means a lot less work for me! So since I cannot use the bindings I previously made I had to come up with something new.<br /><br />Anyways let us get to the fun stuff and let me explain the code below.<br /><ul><li><i><b>Home.axml</b></i> is the Android View, which contains the <i>ViewPager</i> and an optional <i>ViewPagerIndicator</i> (will post source for this soon, look out for another blog post meanwhile you can use <a href="https://github.com/xamarin/monodroid-samples/blob/master/ViewPagerIndicator/ViewPagerIndicator" target="_blank">this</a>) - very simple no bindings here.<i><b> </b></i></li><li><i><b>HomeViewModel.cs</b></i> is a simple <i>ViewModel</i>, similar to one you would use for a Tab kind of View, which instantiates other <i>ViewModels</i> to use for each tab, or in this case for each page in the <i>ViewPager</i>.<i><b> </b></i></li><li><i><b>MvxViewPagerFragmentAdapter.cs</b></i> is what we need to inform <i>ViewPager</i> about our <i>Fragments</i>. It needs to know about at least the <i>Type</i> of the <i>Fragment</i> and the <i>ViewModel</i> associated to it. The <i>Title</i> is just for convenience when using a <i>ViewPagerIndicator</i>. Basically what happens in <i>GetItem</i> is that a <i>Fragment</i> of a specific <i>Type</i> gets instantiated and the <i>DataContext</i> for that <i>Fragment</i> is set. This way the <i>Fragment</i> itself can create bindings to <i>Properties</i> and <i>Commands</i> internally. <i>GetPageTitleFormatted</i> is simple for a <i>ViewPagerIndicator</i>. <i>FragmentJavaName</i> and <i>FragmentInfo</i> was highly inspired by the <a href="https://github.com/slodge/MvvmCross/blob/v3/Cirrious/Cirrious.MvvmCross.Droid.Fragging/MvxTabsFragmentActivity.cs" target="_blank"><i>MvxTabsFragmentActivity</i></a> which kind of does the same thing as this <i>Adapter</i> but with a lot more stuff to make it work with a <i>TabHost</i>.<b><i> <br /> </i></b></li><li><b><i>HomeView.cs</i></b> now this last piece of code, simply creates the <i>FragmentInfo</i> instances for the <i>Fragments</i> I want to display in the <i>ViewPager</i> and gives that information to the <i>Adapter</i> which is set for the <i>ViewPager.</i></li></ul>This is basically it. See the video for a quick run through of the code and how it looks at the end of it. <br /><div class="separator" style="clear: both; text-align: center;"><object width="320" height="266" class="BLOGGER-youtube-video" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0" data-thumbnail-src="http://i1.ytimg.com/vi/fGsEHVOy8Q0/0.jpg"><param name="movie" value="http://www.youtube.com/v/fGsEHVOy8Q0?version=3&f=user_uploads&c=google-webdrive-0&app=youtube_gdata" /><param name="bgcolor" value="#FFFFFF" /><param name="allowFullScreen" value="true" /><embed width="320" height="266"  src="http://www.youtube.com/v/fGsEHVOy8Q0?version=3&f=user_uploads&c=google-webdrive-0&app=youtube_gdata" type="application/x-shockwave-flash" allowfullscreen="true"></embed></object></div><br /><script class="brush: xml;" title="Home.axml" type="syntaxhighlighter"><![CDATA[ <?xml version="1.0" encoding="utf-8"?><LinearLayout   xmlns:android="http://schemas.android.com/apk/res/android"   android:orientation="vertical"   android:layout_width="fill_parent"   android:layout_height="fill_parent">  <dk.ostebaronen.droid.viewpagerindicator.TitlePageIndicator     android:id="@+id/viewPagerIndicator"     android:padding="10dip"     android:layout_height="wrap_content"     android:layout_width="fill_parent"     />  <android.support.v4.view.ViewPager     android:id="@+id/viewPager"     android:layout_width="fill_parent"     android:layout_height="0dp"     android:layout_weight="1" /></LinearLayout>]]></script> <script class="brush: csharp;" title="HomeView.cs" type="syntaxhighlighter"><![CDATA[ using System.Collections.Generic; using Android.App; using Android.Support.V4.View; using Cirrious.MvvmCross.Droid.Fragging; using Cirrious.MvvmCross.Droid.Views; using DK.Ostebaronen.Droid.ViewPagerIndicator; using CoolProject.Core.ViewModels; using CoolProject.Droid.Adapters; using CoolProject.Droid.Views.Fragments;  namespace CoolProject.Droid.Views {   [Activity(Label = "Home")]   public class HomeView : MvxFragmentActivity   {     private ViewPager _viewPager;     private TitlePageIndicator _pageIndicator;     private MvxViewPagerFragmentAdapter _adapter;      public new HomeViewModel ViewModel     {       get { return (HomeViewModel)base.ViewModel; }       set { base.ViewModel = value; }     }          protected override void OnCreate(Android.OS.Bundle bundle)     {       base.OnCreate(bundle);        SetContentView(Resource.Layout.Home);        var fragments = new List<MvxViewPagerFragmentAdapter.FragmentInfo>      {         new MvxViewPagerFragmentAdapter.FragmentInfo         {           FragmentType = typeof(FirstFragment),           Title = "Fragment1",           ViewModel = ViewModel.First         },         new MvxViewPagerFragmentAdapter.FragmentInfo         {           FragmentType = typeof(SecondFragment),           Title = "Fragment2",           ViewModel = ViewModel.Second         },         new MvxViewPagerFragmentAdapter.FragmentInfo         {           FragmentType = typeof(ThirdFragment),           Title = "Fragment3",           ViewModel = ViewModel.Third         }       };        _viewPager = FindViewById<viewpager>(Resource.Id.viewPager);       _adapter = new MvxViewPagerFragmentAdapter(this, SupportFragmentManager, fragments);       _viewPager.Adapter = _adapter;        _pageIndicator = FindViewById<titlepageindicator>(Resource.Id.viewPagerIndicator);        _pageIndicator.SetViewPager(_viewPager);       _pageIndicator.CurrentItem = 0;     }   } } ]]></script> <script class="brush: csharp;" title="HomeViewModel.cs" type="syntaxhighlighter"><![CDATA[ using System.Windows.Input; using Cirrious.MvvmCross.Plugins.Location; using Cirrious.MvvmCross.Plugins.PictureChooser; using Cirrious.MvvmCross.ViewModels; using CoolProject.Core.Services;  namespace CoolProject.Core.ViewModels {   public class HomeViewModel     : MvxViewModel   {     private readonly ICoolService _service;     public HomeViewModel(ICoolService service, IMvxGeoLocationWatcher geoLocationWatcher, IMvxPictureChooserTask pictureChooserTask)     {       _service = service;       First = new FirstViewModel(service, geoLocationWatcher);       Second = new SecondViewModel(service);       Third = new ThirdViewModel(service, pictureChooserTask);     }     ...   } } ]]></script><br/><script class="brush: csharp;" title="MvxViewPagerFragmentAdapter.cs" type="syntaxhighlighter"><![CDATA[ using System; using System.Collections.Generic; using System.Linq; using Android.Content; using Android.Support.V4.App; using Cirrious.MvvmCross.Droid.Fragging.Fragments; using Cirrious.MvvmCross.ViewModels;  namespace CoolProject.Droid.Adapters {   public class MvxViewPagerFragmentAdapter     : FragmentPagerAdapter   {     public class FragmentInfo     {       public string Title { get; set; }       public Type FragmentType { get; set; }       public IMvxViewModel ViewModel { get; set; }     }      private readonly Context _context;          public MvxViewPagerFragmentAdapter(       Context context, FragmentManager fragmentManager, IEnumerable<fragmentinfo> fragments)       : base(fragmentManager)     {       _context = context;       Fragments = fragments;     }      public IEnumerable<fragmentinfo> Fragments { get; private set; }      public override int Count     {       get { return Fragments.Count(); }     }      public override Fragment GetItem(int position)     {       var frag = Fragments.ElementAt(position);       var fragment = Fragment.Instantiate(_context,                                           FragmentJavaName(frag.FragmentType));       ((MvxFragment)fragment).DataContext = frag.ViewModel;       return fragment;     }      protected virtual string FragmentJavaName(Type fragmentType)     {       var namespaceText = fragmentType.Namespace ?? "";       if (namespaceText.Length > 0)           namespaceText = namespaceText.ToLowerInvariant() + ".";       return namespaceText + fragmentType.Name;     }      public override Java.Lang.ICharSequence GetPageTitleFormatted(int p0) { return new Java.Lang.String(Fragments.ElementAt(p0).Title); }   } } ]]></script> 