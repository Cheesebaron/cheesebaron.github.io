---
layout: post
title: Cake build issue reporting with PRCA
date: '2017-08-28T12:39:00.003+02:00'
author: Tomasz Cielecki
comments: true
tags:
- Issues
- Build
- Cake
modified_time: '2017-08-28T13:36:18.019+02:00'
thumbnail: https://1.bp.blogspot.com/-lN0Pqo0qOA8/WaPykTiaBpI/AAAAAAAAEMQ/QyEktFWY-foTwJqL6WTgyV7lmnbqCW2cACLcBGAs/s72-c/prca.png
blogger_id: tag:blogger.com,1999:blog-3433282516380174051.post-3147012530008376389
blogger_orig_url: http://blog.ostebaronen.dk/2017/08/cake-build-issue-reporting-with-prca.html
---

I have covered Cake build in one of my talks I did for a local user group I participate in Copenhagen. However, most of that just explained what Cake build is. If you are reading this and have no idea what Cake build is, I highly recommend looking at the <a href="https://cakebuild.net/">Cake homepage</a> and also <a href="https://www.youtube.com/watch?v=zZIyEn4jF2U">watching this introduction by Gary Ewan Park</a>, which explains very well what is great about Cake.<br /><br />Once you have set up your Cake build, you may wonder how to process all the warnings and issues that MSBuild throws at you. You may also be running the ReSharper command line analysis tool which finds issues with your code. How do you combine all these results and report them or go through them to figure out what is going on?<br /><a href="https://github.com/pascalberger"><br /></a><a href="https://github.com/pascalberger">Pascal Berger</a> has written some great add-ins for Cake, which helps you with this, called Pull Request Code Analysis (PRCA). Let's try set it up for both MSBuild and ReSharper code Analysis.<br /><br /><h4>Add-ins and tools</h4>In your build script you need to add a couple of tools and addins.<br /><br /><div><script src="https://gist.github.com/Cheesebaron/0ab0ac35559e7ff67bdd2d86c717a973.js?file=addins.cs"></script></div><br />In the snippet above, we start by adding the ReSharper CommandLineTools, for analyzing with either the default ReSharper rules or one or more rule sets that you have defined for your solution.<br />We also add MSBuild Extension Pack, which allows us to use an XML file format that PRCA knows how to parse. The default logging format does not work.<br /><br />Then we add the relevant PRCA addins. In this case I am only interested in catching issues with my code. However, PRCA also supports reporting the issues it finds into TFS/VSTS pull requests.<br /><br /><h4>MSBuild</h4>Having added the required add-ins and tools for all this to work. Let's add some settings to our MSBuild, such that it can log the build in the format PRCA understands. <br /><div><script src="https://gist.github.com/Cheesebaron/0ab0ac35559e7ff67bdd2d86c717a973.js?file=msbuild.cs"></script></div><br />Here the important parts is the call to <i>WithLogger</i>, which sets up file logging to XML. The rest is up to you to figure out. I like to pass along the configuration as arguments in my scripts, which is where the configuration and platform variables come from. In this case we are logging to <i>msbuildLogPath</i>&nbsp;which is up to you to decide where is. It could for instance be in an artifacts folder.<br /><br /><h4>ReShaper Inspect Code</h4><div>Now let's add some static analysis into the mix and lets get some results from the ReSharper CLI tools. A ReShaper license is not required to use the CLI tool, so there is basically no reason not to use it if you want to improve your code.</div><br />The CLI tool just like the plugin for Visual Studio also supports extensions, which is great for adding additional analysis. This can help you catch spelling mistakes and other cool additions through the extensions. <br /><div><br /><div><script src="https://gist.github.com/Cheesebaron/0ab0ac35559e7ff67bdd2d86c717a973.js?file=resharper-cli.cs"></script></div><br /></div>We pass along similar MSBuild properties as we did in our build. The <i>Profile</i> property here is the ReSharper settings file. You can configure multiple layers of settings here, similarly to what ReShaper allows you in the VS extension. <br />I have chosen not to throw exceptions when finding violations, so I can report them at the end of a build if the rest of it succeeds. You can see I added a couple of extensions in the <i>Extensions</i>&nbsp;property. One for checking spelling and ensuring <i>async</i>&nbsp;suffix on async methods.<br />An important note here is the contents of <i>ArgumentCustomization</i>. On my environment, the CLI tool seems confused about which MSBuild version to use. Even though the documentation claims to always use the latest version, it still picked up an old version. Hence, I had to specify <i>--toolset=15.0</i>&nbsp;myself to make it work.<br />The <i>InspectCode</i>&nbsp;tool takes a little while to run. In my case here it dumps the results in a log file at <i>inspectReportFilePath</i>. Just like with MSBuild, you could put that in artifacts or where ever you like.<br /><br /><h4>Reading issues</h4><div>Now to tie this blog post up, we now need to read the issues logged from both the build and the ReSharper code inspection. This is what PRCA excels at.</div><br /><div><script src="https://gist.github.com/Cheesebaron/0ab0ac35559e7ff67bdd2d86c717a973.js?file=read-issues.cs"></script></div><br />Here I simply check existence of the msbuild log and the code inspection report and run the <i>ReadIssues</i> tool. From this I get a <i>IEnumerable&lt;<a href="https://cake-contrib.github.io/Cake.Prca.Website/api/Cake.Prca.Issues/ICodeAnalysisIssue/">ICodeAnalysisIssue</a>&gt; </i>which gives you the path to the file where the issue is in, the line, the message, which rule it violates and url to the rule documentation. From this you can get a very good idea about how to resolve the issue being reported.<br /><br />There are plans on adding tools to create reports in various formats from this enumerable, currently you need to do something about the issues yourself, which highly depends on the environment you use to report issues, make pull requests etc.<br />If you are using TFS/VSTS there are built in methods to report these. <a href="https://cake-contrib.github.io/Cake.Prca.Website/docs/usage/tutorials/teamcity-with-tfs">More information can be found in the PRCA docs</a>.<br /><br />When you run the PRCA tool it will look something like this in your cake output.<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-lN0Pqo0qOA8/WaPykTiaBpI/AAAAAAAAEMQ/QyEktFWY-foTwJqL6WTgyV7lmnbqCW2cACLcBGAs/s1600/prca.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="252" data-original-width="536" height="188" src="https://1.bp.blogspot.com/-lN0Pqo0qOA8/WaPykTiaBpI/AAAAAAAAEMQ/QyEktFWY-foTwJqL6WTgyV7lmnbqCW2cACLcBGAs/s400/prca.png" width="400" /></a></div><div class="separator" style="clear: both; text-align: left;">As you see this project I've run it on has a lot of issues ðŸ˜¢</div><br />