---
layout: post
title: Filtering ListView with SearchView in Xamarin.Android
date: '2014-03-30T22:18:00.000+02:00'
author: Tomasz Cielecki
tags:
- Xamarin.Android
modified_time: '2014-03-30T22:33:34.727+02:00'
thumbnail: https://i1.ytimg.com/vi/4FvObC44bhM/0.jpg
blogger_id: tag:blogger.com,1999:blog-3433282516380174051.post-1639656096593407403
blogger_orig_url: http://blog.ostebaronen.dk/2014/03/filtering-listview-with-searchview-in.html
---

I recently made a video describing how to add a <i>SearchView </i>to your <i>ActionBar</i>, using the Support v7 package to provide backwards support, all this done in Xamarin.Android! I posted it on the Xamarin Forum's, University section, which I have access to, since I am attending Xamarin University. There were some interesting questions, which I found solutions for and I simply wanted to share them, so I am writing this blog post to do so. For background knowledge take a look at this video, which started this, and I am going to use that as a starting point for this blog post.<br /><br /><div class="separator" style="clear: both; text-align: center;"><object class="BLOGGER-youtube-video" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0" data-thumbnail-src="https://i1.ytimg.com/vi/4FvObC44bhM/0.jpg" height="266" width="320"><param name="movie" value="https://www.youtube.com/v/4FvObC44bhM?version=3&f=user_uploads&c=google-webdrive-0&app=youtube_gdata" /><param name="bgcolor" value="#FFFFFF" /><param name="allowFullScreen" value="true" /><embed width="320" height="266"  src="https://www.youtube.com/v/4FvObC44bhM?version=3&f=user_uploads&c=google-webdrive-0&app=youtube_gdata" type="application/x-shockwave-flash" allowfullscreen="true"></embed></object></div><br />So the video, shows a very simple implementation of <i>SearchView</i>, which filters simple string elements feeded into the <i>ArrayAdapter</i>, which already has a nice simple <i>Filter</i>&nbsp;implementation, which simply matches the search query to see if it is contained in the items in the <i>ListView</i>. Now this simple implementation might not be sufficient enough for you, because as soon as you need to show something more complicated in a <i>ListView</i>, you will need to implement your own <i>Adapter.</i>&nbsp;Doing so will also require you to implement your own <i>Filter</i>&nbsp;as the <i>Adapter</i>&nbsp;you implement yourself cannot know what arbitrary data you will present.<br /><br /><h3>SearchView filtering ArrayAdapter</h3>Anyways, enough talk, let us dive into the code. So easy mode as described in the video and&nbsp;<a href="https://gist.github.com/Cheesebaron/9670295" target="_blank">gist</a>:<br /><br /><script src="https://gist.github.com/Cheesebaron/9670295.js?file=SearchViewActivity.cs"></script> So here the magic happens in the <i>OnCreateOptionsMenu</i> method line 39-58, where we find the <i>ActionBar MenuItem </i>and subscribe to the <i>SearchView's ActionView </i>query changes, which invokes the default Filter in the <i>ArrayAdapter</i>.<br /><br /><h3>Reacting on SearchView Expand/Collapse</h3><div>One of the questions that popped up was, when having the back Action enabled in the <i>ActionBar </i>when using the <i>SearchView</i>, how do you react to the Expand and Collapse events? This is pretty simple, but might not be that super obvious.</div><div><br /></div><div>You have to create a class implementing <i>IOnActionExpandListener.&nbsp;</i>In this example I am going to remove the filter from the Adapter when collapsing the <i>SearchView</i>.</div><div><br /><script src="https://gist.github.com/Cheesebaron/9670295.js?file=SearchViewExpandListener.cs"></script></div><br />To hook it up to the <i>SearchView</i> you have to use the helper class <i>MenuItemCompat</i>, to attach it to the <i>MenuItem</i>&nbsp;which you do in the <i>OnCreateOptionsMenu</i>: <br /><script src="https://gist.github.com/Cheesebaron/9670295.js?file=gistfile1.cs"></script> <br /><h3>Filtering in custom Adapters</h3><div>Now the other question was, how do I filter my custom <i>Adapter</i>? Very good question if you ask me. As already mentioned, for that you have to implement your own <i>Filter</i>, as the nature of a custom <i>Adapter </i>is that you present custom stuff. Hence the default <i>Filter </i>implementation cannot know how to filter that. I am just going to replicate what the default <i>Filter </i>does on a string property of the model I am going to present in the <i>ListView</i>.<br /><br /></div><div><b>The final solution can be found on → <a href="https://github.com/Cheesebaron/SearchView-Sample">GitHub</a> ←</b><br /><br /></div><div>So before we begin I have to warn you that <i>FilterResult</i>&nbsp;which is used to store the filtered values temporarily, expects that the object stored is a Java type. So either your model which you populate your <i>Adapter</i>&nbsp;with has to implement <i>Java.Lang.Object</i>&nbsp;or you will have to wrap your values. I will show you the latter, as it will apply to the more use cases, as you probably cannot and probably do not want to implement <i>Java.Lang.Object</i>&nbsp;in your contracts or whatever you are using to store data in, especially when you are communicating and sharing code between platforms.</div><div><br /></div><div>To wrap up .NET types with a Java type I am using modified code from this <a href="http://lists.ximian.com/pipermail/monodroid/2012-June/010643.html" target="_blank">monodroid mailing list thread</a>, which looks like this:</div><div><br /></div><div><br /></div><script src="https://gist.github.com/Cheesebaron/9876783.js"></script> <br /><div><br /></div>The main difference is that the Java holder object is disposed of immediately when it is converted to a .NET object. Also the comparison in the original source, whether the value was null is unsafe, as it does not take value types into consideration. The object disposal is very useful to keep GREF references down to a minimum. I really don't want the app to run high on memory.<br /><br />Now with that covered, let us get to the actual Adapter and Filter. I have created a class called Chemical, which has Name and DrawableId property. Which are going to be assigned to a custom view, in the Adapter. Not going to cover View creation here, but this one is pretty simple, really.<br /><br />So Chemical looks like this:<br /><br /><script src="https://gist.github.com/Cheesebaron/9838325.js?file=Chemical.cs"></script>And the Adapter looks like this:<br /><br /><script src="https://gist.github.com/Cheesebaron/9838325.js?file=ChemicalsAdapter.cs"></script><br />So I am just going to describe what happens in the custom <i>ChemicalFilter</i>, as the rest of the Adapter is pretty trivial. So first thing is that I have to pop in the reference to the <i>ChemicalsAdapter</i>, because I want to store both the original list of <i>Chemicals </i>and the filtered version in the <i>Adapter</i>, so we always can go back to the state we started at. So I always look for matches in the <i>_originalData</i> field, which is looped and matched, lower case, if the <i>Chemical</i> contains anything in the <i>ICharSequence </i>which is passed into the <i>PerformFiltering </i>method. The <i>ICharSequence</i> is just a spartan Java interface providing some simple methods such as lenght, getting a char at at specific position and a sub sequence of chars, nothing too fancy. I simply convert that to a string and match against the <i>Chemical</i> <i>Name</i> property. So the results of that matching is transformed into an array of Java objects, with help of the modifier .NET to Java wrapper I described above using a bit of LINQ. This is done since FilterResults expects an array of Java objects. I also call <i>Dispose </i>on the <i>ICharSquence</i>, as it seems like not doing so builds up the GREF count. <br /><br />Now in <i>PublishResults </i>the values are converted back to the <i>Chemical </i>.NET type also using a bit of LINQ. The results are set in the Adapter's _item field and the Adapter is notified of the changes in the data set. Both arguments are Disposed of. <br /><br />So, this is pretty simple stuff. It is just the conversion from Java to .NET and the other way around that can cause some troubles. So just keep in mind, that if your GREF count is rising, then you should probably look into <i>Disposing </i>of some of your stuff. <br /><br /><div><b>Again the final solution can be found on → <a href="https://github.com/Cheesebaron/SearchView-Sample">GitHub</a> ←</b></div>